{% extends "base.html" %}

{% block title %}Conversation | Medical Case Search{% endblock %}

{% block extra_css %}
<style>
  .detail-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
  }
  .detail-header {
    margin-bottom: 1.5rem;
  }
  .detail-header h2 {
    color: var(--primary-green, #7bc148);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .breadcrumb-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
  .breadcrumb-nav a {
    color: var(--primary-green, #7bc148);
    text-decoration: none;
  }
  .breadcrumb-nav a:hover {
    text-decoration: underline;
  }
  .breadcrumb-nav .separator {
    color: #9ca3af;
  }
  .breadcrumb-nav .current {
    color: #6b7280;
  }
  .info-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6b7280;
    font-size: 0.9rem;
  }
  .info-item strong {
    color: #374151;
  }
  .messages-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  .messages-header {
    background: var(--primary-green, #7bc148);
    color: white;
    padding: 1rem 1.5rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .messages-list {
    max-height: 600px;
    overflow-y: auto;
  }
  .message-item {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }
  .message-item:last-child {
    border-bottom: none;
  }
  .message-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .role-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
  }
  .role-patient {
    background: #dbeafe;
    color: #1e40af;
  }
  .role-clinician {
    background: #dcfce7;
    color: #166534;
  }
  .role-recommender {
    background: #fef3c7;
    color: #92400e;
  }
  .role-system {
    background: #f3f4f6;
    color: #4b5563;
  }
  .message-time {
    font-size: 0.8rem;
    color: #9ca3af;
  }
  .message-content {
    color: #374151;
    line-height: 1.6;
  }
  .empty-messages {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
  }
  .btn-new {
    background: var(--primary-green, #7bc148);
    color: white;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-new:hover {
    background: #6aab3d;
    color: white;
  }
  .btn-back {
    background: transparent;
    color: var(--primary-green, #7bc148);
    border: 1px solid var(--primary-green, #7bc148);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-back:hover {
    background: var(--primary-green, #7bc148);
    color: white;
  }
  .action-buttons {
    display: flex;
    gap: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<!-- Top Menu Bar -->
<div class="top-menu">
  <div class="menu-left">
    <div class="logo">
      <i data-lucide="activity"></i>
      <span>Cancer Dx</span>
    </div>
    <nav class="nav-links">
      <a href="{{ url_for('index') }}" class="nav-link">
        <i data-lucide="home"></i>
        <span>Home</span>
      </a>
      <a href="{{ url_for('history_page') }}" class="nav-link active">
        <i data-lucide="clock"></i>
        <span>History</span>
      </a>
      {% if current_user.is_authenticated and current_user.is_admin %}
      <a href="{{ url_for('admin_page') }}" class="nav-link">
        <i data-lucide="shield"></i>
        <span>Admin</span>
      </a>
      {% endif %}
    </nav>
  </div>
  <div class="menu-right">
    {% if current_user.is_authenticated %}
    <div class="user-dropdown">
      <button class="user-btn" id="userDropdownBtn">
        <i data-lucide="user"></i>
        <span>{{ current_user.email }}</span>
        <i data-lucide="chevron-down"></i>
      </button>
      <div class="dropdown-menu" id="userDropdownMenu">
        <a href="{{ url_for('auth.logout_redirect') }}" class="dropdown-item">
          <i data-lucide="log-out"></i>
          <span>Logout</span>
        </a>
      </div>
    </div>
    {% else %}
    <a href="{{ url_for('index') }}" class="btn btn-login">
      <i data-lucide="log-in"></i>
      <span>Login</span>
    </a>
    {% endif %}
  </div>
</div>

<div class="detail-container">
  <!-- Breadcrumb -->
  <div class="breadcrumb-nav">
    <a href="{{ url_for('history_page') }}">
      <i data-lucide="arrow-left" style="width:16px;height:16px"></i> History
    </a>
    <span class="separator">/</span>
    <span class="current">Conversation</span>
  </div>

  <!-- Header with actions -->
  <div class="detail-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h2>
      <i data-lucide="message-square"></i>
      Conversation Details
    </h2>
    <div class="action-buttons">
      <a href="{{ url_for('history_page') }}" class="btn btn-back">
        <i data-lucide="arrow-left" style="width:16px;height:16px"></i> Back
      </a>
      {% set new_url = url_for('new_conversation', patient_id=patient_id) if patient_id else url_for('new_conversation') %}
      <a href="{{ new_url }}" class="btn btn-new">
        <i data-lucide="plus" style="width:16px;height:16px"></i> New Conversation
      </a>
    </div>
  </div>

  <!-- Info Card -->
  <div class="info-card">
    <div class="info-item">
      <i data-lucide="calendar" style="width:16px;height:16px"></i>
      <strong>Started:</strong>
      <span>{{ created_at.strftime('%Y-%m-%d %H:%M') if created_at else '—' }}</span>
    </div>
    {% if patient_label %}
    <div class="info-item">
      <i data-lucide="user" style="width:16px;height:16px"></i>
      <strong>Patient:</strong>
      <span>{{ patient_label }}</span>
    </div>
    {% endif %}
    <div class="info-item">
      <i data-lucide="message-circle" style="width:16px;height:16px"></i>
      <strong>Messages:</strong>
      <span>{{ messages|length }}</span>
    </div>
  </div>

  <!-- Messages Card -->
  <div class="messages-card">
    <div class="messages-header">
      <i data-lucide="messages-square" style="width:20px;height:20px"></i>
      Messages
    </div>
    <div class="messages-list">
      {% for m in messages %}
      <div class="message-item">
        <div class="message-meta">
          <span class="role-badge
            {% if m.role == 'patient' %}role-patient
            {% elif m.role == 'clinician' %}role-clinician
            {% elif m.role == 'Question Recommender' or m.type == 'question_recommender' %}role-recommender
            {% else %}role-system{% endif %}">
            {% if m.role == 'patient' %}
              <i data-lucide="user" style="width:12px;height:12px"></i>
            {% elif m.role == 'clinician' %}
              <i data-lucide="stethoscope" style="width:12px;height:12px"></i>
            {% elif m.role == 'Question Recommender' or m.type == 'question_recommender' %}
              <i data-lucide="lightbulb" style="width:12px;height:12px"></i>
            {% else %}
              <i data-lucide="bot" style="width:12px;height:12px"></i>
            {% endif %}
            {{ m.role or 'message' }}
          </span>
          <span class="message-time">
            {{ m.timestamp or (m.created_at.strftime('%Y-%m-%d %H:%M') if m.created_at else '') }}
          </span>
        </div>
        <div class="message-content">{{ m.message or '—' }}</div>
      </div>
      {% else %}
      <div class="empty-messages">
        <i data-lucide="message-square-off" style="width:48px;height:48px;color:#9ca3af"></i>
        <p class="mt-3">No messages in this conversation.</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
(function() {
  // Initialize Lucide icons
  if (typeof lucide !== 'undefined') lucide.createIcons();

  // User dropdown toggle
  const userBtn = document.getElementById('userDropdownBtn');
  const userMenu = document.getElementById('userDropdownMenu');
  if (userBtn && userMenu) {
    userBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      userMenu.classList.toggle('show');
    });
    document.addEventListener('click', function() {
      userMenu.classList.remove('show');
    });
  }
})();
</script>
{% endblock %}
