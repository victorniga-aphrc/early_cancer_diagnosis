{% extends "base.html" %}

{% block content %}
<!-- Auth Gate (hidden on load when user is already logged in to avoid flash) -->
<div id="auth-gate" class="auth-gate"{% if current_user.is_authenticated %} style="display:none"{% endif %}>
  <div class="auth-card">
    <!-- Error banner -->
    <div id="auth-error" class="alert alert-danger d-none" role="alert"></div>

    <!-- LOGIN CARD -->
    <div id="login-card">
      <h4>Welcome back</h4>
      <form id="login-form">
        <div class="mb-3">
          <label for="login-email" class="form-label">Email</label>
          <input type="email" id="login-email" class="form-control" autocomplete="username" required>
        </div>
        <div class="mb-3">
          <label for="login-password" class="form-label">Password</label>
          <input type="password" id="login-password" class="form-control" autocomplete="current-password" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Log in</button>
      </form>
      <div class="text-center mt-3">
        <small class="text-muted">No account?</small>
        <button class="btn btn-link p-0 align-baseline" data-action="show-signup">Create one</button>
      </div>
    </div>

    <!-- SIGNUP CARD (hidden by default) -->
    <div id="signup-card" class="d-none">
      <h4>Create your account</h4>
      <form id="signup-form">
        <div class="mb-3">
          <label for="signup-username" class="form-label">Username</label>
          <input type="text" id="signup-username" class="form-control" autocomplete="username" minlength="2"
            maxlength="64" placeholder="How you want to be shown (e.g. Dr. Jane)" required>
          <div class="form-text">Letters, numbers, . _ - only. 2-64 characters.</div>
        </div>
        <div class="mb-3">
          <label for="signup-email" class="form-label">Email</label>
          <input type="email" id="signup-email" class="form-control" autocomplete="email" required>
        </div>
        <div class="mb-3">
          <label for="signup-password" class="form-label">Password</label>
          <input type="password" id="signup-password" class="form-control" autocomplete="new-password" required>
        </div>
        <button type="submit" class="btn btn-success w-100">Sign up</button>
      </form>
      <div class="text-center mt-3">
        <small class="text-muted">Already have an account?</small>
        <button class="btn btn-link p-0 align-baseline" data-action="show-login">Log in</button>
      </div>
    </div>
  </div>
</div>

{% if current_user.is_authenticated %}
<!-- Top Menu Bar (shown when logged in - no JS wait needed) -->
<nav class="top-menu-bar">
  <div class="menu-brand">
    <i data-lucide="activity" style="width:20px;height:20px;color:var(--primary-green)"></i>
    <span>Early Cancer Diagnosis</span>
  </div>
  <div class="menu-right">
    <a href="{{ url_for('history_page') }}" class="nav-link-custom">
      <i data-lucide="history" style="width:14px;height:14px"></i>
      History
    </a>
    {% for role in current_user.roles %}
    {% if role.name == "admin" %}
    <a href="{{ url_for('admin_page') }}" class="admin-link">
      <i data-lucide="settings" style="width:14px;height:14px"></i>
      Admin
    </a>
    {% endif %}
    {% endfor %}
    <span class="user-info" id="whoami">
      <i data-lucide="user" style="width:14px;height:14px"></i>
      {% if current_user.username %}{{ current_user.username }}{% elif current_user.email %}{{ current_user.email.split('@')[0] }}{% else %}User{% endif %}
    </span>
    <button id="logout-btn" class="logout-btn">
      <i data-lucide="log-out" style="width:14px;height:14px"></i>
      Log out
    </button>
  </div>
</nav>

<!-- Main App Container -->
<div id="app-container" class="app-container">

  <!-- Left Panel -->
  <div class="panel panel-left custom-scrollbar" id="panel-left" style="width: 340px;">
    <div class="panel-content">

      <!-- Header -->
      <div class="panel-header">
        <div class="panel-header-icon">
          <i data-lucide="stethoscope"></i>
        </div>
        <div class="panel-header-text">
          <h1>Medical Case Search</h1>
          <p>AI-powered matching</p>
        </div>
      </div>

      <!-- Search Section -->
      <div class="space-y">
        <div class="section-label">
          <i data-lucide="sparkles" class="orange"></i>
          Cancer Q-Recommender
        </div>

        <div class="search-input-wrapper">
          <i data-lucide="search"></i>
          <input type="text" id="searchQuery" class="search-input" placeholder="Enter symptoms...">
        </div>

        <div class="search-row">
          <select id="maxResults" class="custom-select">
            <option value="5">5 Results</option>
            <option value="10">10 Results</option>
          </select>
          <button type="button" id="searchBtn" class="btn-green">
            <i data-lucide="search"></i>
            Search
          </button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Conversation Controls -->
      <div class="space-y">
        <div class="controls-row">
          <span class="section-label" style="margin-bottom:0">
            <i data-lucide="file-text" class="green"></i>
            Agents Conversation
          </span>
          <button type="button" id="resetBtn" class="btn-orange-outline">
            <i data-lucide="refresh-cw" style="width:10px;height:10px"></i>
            Reset
          </button>
        </div>

        <!-- Mode & Language Settings -->
        <div class="controls-row-inline">
          <select id="chatMode" class="custom-select custom-select-small">
            <option value="real">Real Actors</option>
            <option value="simulated">Simulated</option>
            <option value="live">Live (Mic)</option>
          </select>
          <select id="languageMode" class="custom-select custom-select-small">
            <option value="bilingual">EN & SW</option>
            <option value="english">English Only</option>
            <option value="swahili">Swahili Only</option>
          </select>
        </div>

        <!-- Patient Selector -->
        <div class="controls-row-inline">
          <select id="patientSelect" class="custom-select custom-select-small" style="flex:1">
            <option value="">-- No Patient --</option>
          </select>
          <button type="button" id="newPatientBtn" class="btn-orange-outline">
            <i data-lucide="plus" style="width:10px;height:10px"></i>
            Patient
          </button>
        </div>

        <!-- Turn-based Pane -->
        <div id="turnPane">
          <!-- Role Toggle -->
          <div id="roleSelector" class="controls-row">
            <label style="font-size:0.75rem;color:var(--gray-600)">Speaking as:</label>
            <div class="role-toggle">
              <button type="button" id="roleClinicianBtn" class="active-clinician"><i data-lucide="stethoscope" style="width:14px;height:14px"></i> Clinician</button>
              <button type="button" id="rolePatientBtn"><i data-lucide="user" style="width:14px;height:14px"></i> Patient</button>
            </div>
          </div>

          <!-- Suggestion Box -->
          <div id="suggestionBox" class="suggestion-box hidden">
            <button class="close-btn" id="closeSuggestion">
              <i data-lucide="x" style="width:12px;height:12px"></i>
            </button>
            <div class="suggestion-content">
              <i data-lucide="lightbulb"></i>
              <div>
                <p class="suggestion-label">Suggested:</p>
                <p class="suggestion-text" id="suggestionText">Have you noticed any shortness of breath?</p>
                <button class="suggestion-use" id="useSuggestion">Use this &rarr;</button>
              </div>
            </div>
          </div>

          <!-- Chat Input -->
          <div id="chatInputWrapper" class="chat-input-wrapper clinician">
            <div class="chat-input-inner">
              <div class="chat-input-label">
                <span class="role clinician" id="inputRoleLabel">Clinician</span>
                <span class="typing">is typing...</span>
              </div>
              <input type="text" id="agentMessage" class="chat-input-field" placeholder="Ask the patient a question...">
              <div class="chat-input-actions">
                <button type="button" id="recordAudioBtn" class="btn-voice">
                  <i data-lucide="mic" style="width:16px;height:16px"></i>
                  <span>Voice</span>
                </button>
                <button type="button" id="sendBtn" class="btn-send clinician">
                  <i data-lucide="send" style="width:16px;height:16px"></i>
                  <span>Send</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Live Mode Pane -->
        <div id="livePane" class="hidden">
          <div class="info-box">
            <i data-lucide="info"></i>
            <p>Speak and get continuous recommendations. Press Stop to end; use Finalize for summary/plan.</p>
          </div>

          <div class="controls-row">
            <h3 style="font-size:0.875rem;font-weight:600;color:var(--gray-700);margin:0">Live Transcription</h3>
            <span class="mode-badge">Mic Mode</span>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-bottom:0.75rem">
            <label style="font-size:0.75rem;color:var(--gray-600)">Recommendations:</label>
            <select id="liveRecoMode" class="custom-select custom-select-small" style="flex:1">
              <option value="normal">Normal</option>
              <option value="unasked">Unasked (End-only)</option>
            </select>
          </div>

          <div class="info-box">
            <i data-lucide="info"></i>
            <p>Speak normally. You'll see partials while you speak; finals after short pauses.</p>
          </div>

          <div class="live-controls">
            <button type="button" id="startLiveBtn" class="btn-start-live">
              <span>&#9654;</span> Start Live
            </button>
            <button type="button" id="stopLiveBtn" class="btn-stop-live" disabled>
              <span>&#9632;</span> Stop
            </button>
          </div>

          <div>
            <label style="font-size:0.75rem;font-weight:500;color:var(--gray-600);display:block;margin-bottom:6px">Live Line</label>
            <div id="liveLineBox" class="live-line-box">
              <div id="liveIndicator" class="live-indicator hidden">
                <span class="dot ping"></span>
                <span class="dot"></span>
              </div>
              <p id="liveMessage" class="live-line-text">Partials appear here.</p>
            </div>
          </div>
        </div>

        <!-- Final Plan Button -->
        <button type="button" id="finalizeBtn" class="btn-orange" style="width:100%">
          <i data-lucide="file-text" style="width:12px;height:12px"></i>
          Summarize & Final Plan
        </button>
      </div>

      <!-- Footer -->
      <div class="panel-footer">
        <span>Medical Case Search</span>
        <span class="brand">#IamAPHRC</span>
      </div>
    </div>
  </div>

  <!-- Resize Handle Left -->
  <div class="resize-handle" id="resize-left">
    <i data-lucide="grip-vertical" style="width:14px;height:14px"></i>
  </div>

  <!-- Center Panel - Transcript -->
  <div class="panel panel-center custom-scrollbar" id="panel-center">
    <div class="panel-content">
      <!-- Transcript Header -->
      <div class="transcript-header">
        <h2>
          <i data-lucide="file-text"></i>
          Transcript
        </h2>
        <span class="transcript-count" id="messageCount">0 messages</span>
      </div>

      <!-- Transcript Messages -->
      <div id="agentChatTranscript" class="transcript-messages">
        <!-- Messages will be inserted here -->
      </div>

      <!-- Typing Indicator -->
      <div id="typingIndicator" class="typing-indicator hidden">
        <span class="typing-icon clinician" id="typingIcon">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>
        </span>
        <span class="typing-role clinician" id="typingRole">Clinician</span>
        <span class="typing-text">is typing</span>
        <div class="typing-dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>

      <!-- Suggested Questions (moved to suggestionBox below role toggle) -->
      <div class="suggested-box hidden">
        <div class="suggested-box-header">
          <i data-lucide="lightbulb"></i>
          <span>Suggested Questions</span>
        </div>
        <ul id="chatSuggestedQuestions" class="suggested-questions">
          <!-- Questions will be inserted here -->
        </ul>
      </div>
    </div>
  </div>

  <!-- Resize Handle Right -->
  <div class="resize-handle hidden" id="resize-right">
    <i data-lucide="grip-vertical" style="width:14px;height:14px"></i>
  </div>

  <!-- Right Panel - Summary -->
  <div class="panel panel-right custom-scrollbar hidden" id="panel-right" style="width: 300px;">
    <div class="panel-content">
      <!-- Summary Header -->
      <div class="transcript-header">
        <h2>
          <i data-lucide="clipboard-list"></i>
          Summary & Plan
        </h2>
        <button type="button" id="closeSummary" style="background:none;border:none;color:var(--gray-400);cursor:pointer">
          <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
      </div>

      <!-- Summary Content -->
      <div id="summaryContent">
        <div class="summary-section orange">
          <h3><span>&#128100;</span> Conversation Summary</h3>
          <p id="patientSummary">Click "Summarize & Final Plan" to generate a summary based on the conversation.</p>
        </div>

        <div class="summary-section green">
          <h3><i data-lucide="check-circle" class="green"></i> Final Plan</h3>
          <ul id="recommendedPlan">
            <li><span class="check">&#10003;</span> Awaiting recommendations...</li>
          </ul>
        </div>

        <div class="summary-section gray">
          <h3>Follow-up Instructions</h3>
          <p id="followUp">Follow-up details will appear here after analysis.</p>
        </div>

        <div class="action-buttons">
          <button id="exportPdfBtn" class="btn-outline">
            <i data-lucide="file-text" style="width:14px;height:14px"></i>
            Export PDF
          </button>
          <button id="exportWordBtn" class="btn-green">
            <i data-lucide="file-down" style="width:14px;height:14px"></i>
            Export Word
          </button>
        </div>
      </div>
    </div>
  </div>

</div>
{% endif %}

<!-- Unasked Questions Modal -->
<div class="modal fade" id="unaskedModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Unasked Questions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="unasked-list"></div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Audio Element -->
<audio id="recordedAudio" class="hidden" controls></audio>
{% endblock %}
